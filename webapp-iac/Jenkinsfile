pipeline {
  agent any
  options { timestamps() }

  parameters {
    booleanParam(name: 'AUTO_APPROVE', defaultValue: true, description: 'Auto-approve terraform apply')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm

        script {
          def branch = env.BRANCH_NAME ?: sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim()
          env.BRANCH_NAME = branch

          env.TARGET_ENV = (branch == 'master') ? 'prod' :
                           (branch == 'staging') ? 'staging' : 'dev'

          env.ENV_DIR  = "webapp-iac/envs/${env.TARGET_ENV}"
          env.VAR_FILE = "${env.TARGET_ENV}.tfvars"

          echo "✔ Branch Detected: ${env.BRANCH_NAME}"
          echo "✔ Deploying to Environment: ${env.TARGET_ENV}"
          echo "✔ Environment Directory: ${env.ENV_DIR}"
        }
      }
    }

    stage('Terraform (Init + Plan + Apply) with AWS') {
      steps {
        script {
          withAWS(credentials: "aws-dev-iam", region: "ap-south-1") {

            dir("${env.ENV_DIR}") {

              sh """
                set -e
                terraform init -reconfigure
                terraform validate
                terraform plan -var-file=${env.VAR_FILE} -out=tfplan.bin
              """

              if (params.AUTO_APPROVE) {
                sh 'terraform apply -auto-approve tfplan.bin'
              }
            }
          }
        }
      }
    }
  }

  post {
    always {
      script {
        sh """
          if [ -d "${env.ENV_DIR}" ]; then
            cd ${env.ENV_DIR} && terraform output || true
          fi
        """
      }
    }
  }
}
