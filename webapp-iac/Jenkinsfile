pipeline {
  agent any

  parameters {
    choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: 'Select Environment')
    choice(name: 'ACTION', choices: ['apply', 'destroy'], description: 'Select Terraform Action')
  }

  environment {
    AWS_CREDENTIALS = "aws-dev-iam"     // ‚úÖ your real Jenkins credential ID
    REGION = "ap-south-1"
    BASE_DIR = "webapp-iac/envs"
  }

  stages {

    stage("Show Selection") {
      steps {
        script {
          echo """
          ‚úÖ Environment : ${ENV}
          üîß Action      : ${ACTION}
          üìÇ Directory   : ${BASE_DIR}/${ENV}
          üßæ Var File    : ${ENV}.tfvars
          """
        }
      }
    }

    stage("Terraform Init + Validate") {
      steps {
        withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}") {
          dir("${BASE_DIR}/${ENV}") {
            sh """
              set -e
              terraform init -input=false
              terraform validate
            """
          }
        }
      }
    }

    stage("Terraform Plan") {
      steps {
        withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}") {
          dir("${BASE_DIR}/${ENV}") {
            sh """
              set -e
              terraform plan -var-file=${ENV}.tfvars -out=tfplan.bin
            """
          }
        }
      }
    }

    stage("Approval for Destroy (Safety Gate)") {
      when { expression { params.ACTION == "destroy" } }
      steps {
        timeout(time: 2, unit: 'MINUTES') {
          input(message: "‚ö†Ô∏è WARNING: Destroying ${ENV} environment. Proceed?")
        }
      }
    }

    stage("Apply / Destroy") {
      steps {
        withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}") {
          dir("${BASE_DIR}/${ENV}") {
            script {

              if (ACTION == "destroy") {
                echo "üî• Starting Safe Destroy sequence..."

                // ‚úÖ Phase 1: Destroy EC2 instance(s)
                sh """
                  echo "üßπ Phase 1: Destroying EC2 instance(s)..."
                  terraform destroy -auto-approve -target=module.web.aws_instance.web -var-file=${ENV}.tfvars || echo "‚ö†Ô∏è Instance destroy skipped (not found)"
                """

                // ‚úÖ Phase 2: Wait for ENIs to detach from SG
                sh """
                  echo "‚è≥ Checking for attached ENIs..."
                  SG_ID=\$(terraform state show module.web.aws_security_group.web 2>/dev/null | awk '/^id =/ {print \$3}')
                  if [ -n "\$SG_ID" ]; then
                    echo "üîç Found SG ID: \$SG_ID"
                    for i in {1..18}; do
                      ENI_COUNT=\$(aws ec2 describe-network-interfaces --filters "Name=group-id,Values=\$SG_ID" --region ${REGION} --query 'NetworkInterfaces' | jq length)
                      if [ "\$ENI_COUNT" -eq 0 ]; then
                        echo "‚úÖ ENIs detached ‚Äî safe to delete SG"
                        break
                      fi
                      echo "‚è≥ ENIs still attached... retrying in 15s"
                      sleep 15
                    done
                  else
                    echo "‚ÑπÔ∏è SG not found in state or already deleted."
                  fi
                """

                // ‚úÖ Phase 3: Destroy the SG safely (with retries)
                sh """
                  echo "üßπ Phase 3: Destroying Security Group..."
                  for i in {1..3}; do
                    terraform destroy -auto-approve -target=module.web.aws_security_group.web -var-file=${ENV}.tfvars && break || echo "‚ö†Ô∏è Retry SG destroy (attempt \$i)..."
                    sleep 10
                  done
                """

                // ‚úÖ Phase 4: Final cleanup (ensure all gone)
                sh """
                  terraform destroy -auto-approve -var-file=${ENV}.tfvars || echo "‚úÖ Cleanup complete or already destroyed"
                """

              } else {
                echo "üöÄ Applying Terraform configuration..."
                sh """
                  terraform apply -auto-approve -var-file=${ENV}.tfvars
                """
              }
            }
          }
        }
      }
    }
  }

  post {
    always {
      echo "‚úÖ Pipeline finished."
    }

    success {
      script {
        if (ACTION == "apply") {
          withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}") {
            dir("${BASE_DIR}/${ENV}") {
              def ip = sh(script: "terraform output -raw web_public_ip || echo 'N/A'", returnStdout: true).trim()
              echo "üåç Server Public IP: ${ip}"
              echo "üíª SSH Command: ssh ubuntu@${ip}"
            }
          }
        }
      }
    }

    failure {
      echo "‚ùå Pipeline failed ‚Äî check above logs for Terraform or AWS errors."
    }
  }
}
