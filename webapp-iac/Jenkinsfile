pipeline {
  agent any
  options { timestamps() }

  parameters {
    booleanParam(name: 'AUTO_APPROVE', defaultValue: true, description: 'Auto-approve terraform apply')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm

        script {
          // Determine branch
          def branch = env.BRANCH_NAME ?: sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim()
          env.BRANCH_NAME = branch

          // Map to env
          env.TARGET_ENV = (branch == 'master')  ? 'prod'
                        : (branch == 'staging') ? 'staging'
                        : 'dev'

          env.ENV_DIR  = "webapp-iac/envs/${env.TARGET_ENV}"
          env.VAR_FILE = "${env.TARGET_ENV}.tfvars"

          echo "âœ” Branch Detected: ${BRANCH_NAME}"
          echo "âœ” Deploying to Environment: ${TARGET_ENV}"
          echo "âœ” Environment Directory: ${ENV_DIR}"
        }
      }
    }

    stage('AWS Credentials') {
      steps {
        script {
          // Using a single credential for now
          def cred = "aws-dev-iam"
          echo "ðŸ”‘ Using AWS Credential: ${cred}"

          withAWS(credentials: cred, region: 'ap-south-1') {
            sh 'aws sts get-caller-identity'
          }
        }
      }
    }

    stage('Terraform Init') {
      steps {
        dir("${env.ENV_DIR}") {
          sh '''
            set -e
            terraform --version
            terraform init -reconfigure
          '''
        }
      }
    }

    stage('Terraform Plan') {
      steps {
        dir("${env.ENV_DIR}") {
          sh '''
            set -e
            terraform validate
          '''
          sh "terraform plan -var-file=${VAR_FILE} -out=tfplan.bin"
        }
      }
    }

    stage('Terraform Apply') {
      when { expression { return params.AUTO_APPROVE } }
      steps {
        dir("${env.ENV_DIR}") {
          sh 'terraform apply -auto-approve tfplan.bin'
        }
      }
    }
  }

  post {
    always {
      script {
        sh '''
          if [ -d "${ENV_DIR}" ]; then
            cd "${ENV_DIR}" && terraform output || true
          fi
        '''
      }
    }
  }
}
