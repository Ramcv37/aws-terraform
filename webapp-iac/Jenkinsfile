pipeline {
  agent any
  options { timestamps() }

  parameters {
    choice(name: 'ACTION', choices: ['APPLY', 'DESTROY'], description: 'Select APPLY or DESTROY')
    choice(name: 'TARGET_ENV', choices: ['dev', 'staging', 'prod'], description: 'Select Environment')
  }

  environment {
    AWS_REGION = "ap-south-1"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.ENV_DIR  = "webapp-iac/envs/${params.TARGET_ENV}"
          env.VAR_FILE = "${params.TARGET_ENV}.tfvars"

          echo """
          ‚úÖ Target Env: ${params.TARGET_ENV}
          üìÇ Directory:   ${env.ENV_DIR}
          üßæ Var File:    ${env.VAR_FILE}
          üîß Action:      ${params.ACTION}
          """
        }
      }
    }

    stage('Terraform Init + Validate') {
      steps {
        withAWS(credentials: 'aws-dev-iam', region: "${AWS_REGION}") {
          dir("${env.ENV_DIR}") {
            sh """
              set -e
              terraform init
              terraform validate
            """
          }
        }
      }
    }

    stage('Terraform Plan') {
      when {
        expression { params.ACTION == 'APPLY' }
      }
      steps {
        withAWS(credentials: 'aws-dev-iam', region: "${AWS_REGION}") {
          dir("${env.ENV_DIR}") {
            sh """
              terraform plan -var-file=${env.VAR_FILE} -out=tfplan.bin
            """
          }
        }
      }
    }

    stage('Approve Destroy (Safety Check)') {
      when {
        expression { params.ACTION == 'DESTROY' }
      }
      steps {
        timeout(time: 1, unit: 'MINUTES') {
          input message: """
‚ö†Ô∏è WARNING: You are about to DESTROY resources in ${params.TARGET_ENV}!
This action is irreversible.

Press PROCEED to continue or ABORT.
          """
        }
      }
    }

    stage('Apply / Destroy') {
      steps {
        withAWS(credentials: 'aws-dev-iam', region: "${AWS_REGION}") {
          dir("${env.ENV_DIR}") {
            script {
              if (params.ACTION == 'APPLY') {
                sh 'terraform apply -auto-approve tfplan.bin'
              } else {
                sh "terraform destroy -auto-approve -var-file=${env.VAR_FILE}"
              }
            }
          }
        }
      }
    }
  }

  post {
    always {
      script {
        withAWS(credentials: 'aws-dev-iam', region: "${AWS_REGION}") {
          dir("${env.ENV_DIR}") {
            sh "terraform output || true"
          }
        }
      }
    }
  }
}
